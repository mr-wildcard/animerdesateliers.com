import {AstroCheck, DiagnosticSeverity} from "@astrojs/language-server";
import {bold, black, bgWhite, red, cyan, yellow} from "kleur/colors";
import glob from "fast-glob";
import * as path from "path";
import {pathToFileURL} from "url";
import * as fs from "fs";
async function openAllDocuments(workspaceUri, filePathsToIgnore, checker) {
  const files = await glob("**/*.astro", {
    cwd: workspaceUri.pathname,
    ignore: ["node_modules/**"].concat(filePathsToIgnore.map((ignore) => `${ignore}/**`))
  });
  const absFilePaths = files.map((f) => path.resolve(workspaceUri.pathname, f));
  for (const absFilePath of absFilePaths) {
    const text = fs.readFileSync(absFilePath, "utf-8");
    checker.upsertDocument({
      uri: pathToFileURL(absFilePath).toString(),
      text
    });
  }
}
function offsetAt({line, character}, text) {
  let i = 0;
  let l = 0;
  let c = 0;
  while (i < text.length) {
    if (l === line && c === character) {
      break;
    }
    let char = text[i];
    switch (char) {
      case "\n": {
        l++;
        c = 0;
        break;
      }
      default: {
        c++;
        break;
      }
    }
    i++;
  }
  return i;
}
function pad(str, len) {
  return Array.from({length: len}, () => str).join("");
}
async function run() {
}
async function check(astroConfig) {
  const root = astroConfig.projectRoot;
  let checker = new AstroCheck(root.toString());
  await openAllDocuments(root, [], checker);
  let diagnostics = await checker.getDiagnostics();
  let result = {
    errors: 0,
    warnings: 0
  };
  diagnostics.forEach((diag) => {
    diag.diagnostics.forEach((d) => {
      switch (d.severity) {
        case DiagnosticSeverity.Error: {
          console.error(`${bold(cyan(path.relative(root.pathname, diag.filePath)))}:${bold(yellow(d.range.start.line))}:${bold(yellow(d.range.start.character))} - ${d.message}`);
          let startOffset = offsetAt({line: d.range.start.line, character: 0}, diag.text);
          let endOffset = offsetAt({line: d.range.start.line + 1, character: 0}, diag.text);
          let str = diag.text.substring(startOffset, endOffset - 1);
          const lineNumStr = d.range.start.line.toString();
          const lineNumLen = lineNumStr.length;
          console.error(`${bgWhite(black(lineNumStr))}  ${str}`);
          let tildes = pad("~", d.range.end.character - d.range.start.character);
          let spaces = pad(" ", d.range.start.character + lineNumLen - 1);
          console.error(`   ${spaces}${bold(red(tildes))}
`);
          result.errors++;
          break;
        }
        case DiagnosticSeverity.Warning: {
          result.warnings++;
          break;
        }
      }
    });
  });
  if (result.errors) {
    console.error(`Found ${result.errors} errors.`);
  }
  const exitCode = result.errors ? 1 : 0;
  return exitCode;
}
export {
  check,
  run
};
//# sourceMappingURL=data:application/json;base64,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
